<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pro Studio ‚Äî Legendary Pro Trim & AI Enhance</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --bg:#071422; --card:#0b1620; --muted:#98b7c2; --accent1:#06b6d4; --accent2:#7c3aed;
    --glass: rgba(255,255,255,0.03);
    --round:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,#041623 0%, #071421 100%); color:#e6f7fb; padding:18px;
  }
  .wrap{max-width:1280px;margin:0 auto;}
  header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  .title h1{font-size:20px;margin:0}
  .title p{margin:0;color:var(--muted);font-size:13px}

  /* layout */
  .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .card{background:var(--card);border-radius:var(--round);padding:14px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
  .section-title{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .section-title h2{font-size:15px;margin:0}
  .muted{color:var(--muted);font-size:13px}

  .btn{
    background: linear-gradient(90deg,var(--accent2),var(--accent1)); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer;
    font-weight:700; box-shadow:0 8px 24px rgba(3,7,18,0.5); transition:transform .12s ease, box-shadow .12s ease;
  }
  .btn:hover:not([disabled]){ transform:translateY(-3px) }
  .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); padding:8px 10px }
  .btn.small{ padding:8px 10px; font-size:13px; border-radius:8px }
  .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

  input[type=file]{display:block;background:var(--glass);padding:10px;border-radius:10px;color:var(--muted);width:100%;border:1px dashed rgba(255,255,255,0.03)}
  input[type=text], select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
  input[type=range]{width:100%}

  label{display:block;margin-bottom:6px;font-size:13px;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .small{font-size:13px;color:var(--muted)}
  video{width:100%;border-radius:10px;background:#000;border:1px solid rgba(255,255,255,.03)}
  pre.log{height:160px;overflow:auto;padding:8px;background:#03141A;border-radius:10px;border:1px solid rgba(255,255,255,0.03);color:#bfefff;font-size:13px}
  .nav{display:flex;flex-direction:column;gap:8px}
  .timeline{height:110px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:10px;padding:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.02)}
  .track{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
  .handles { position:relative; height:44px; margin-top:8px; }
  .bar { position:absolute; left:0; right:0; top:18px; height:8px; border-radius:6px; background:rgba(255,255,255,0.03); }
  .range { position:absolute; top:8px; height:30px; width:100%; pointer-events:none; }
  .range input[type=range]{ pointer-events:all; -webkit-appearance: none; appearance:none; position:absolute; left:0; top:8px; width:100%; height:30px; background:transparent }
  .thumb { height:30px; width:8px; background:linear-gradient(180deg,var(--accent2),var(--accent1)); border-radius:4px; display:inline-block; }
  .selectedRange { position:absolute; top:18px; height:8px; border-radius:6px; background:linear-gradient(90deg,var(--accent1),var(--accent2)); }
  .timeLabel{display:flex;justify-content:space-between;margin-top:8px;font-size:13px;color:var(--muted)}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">PS</div>
      <div class="title">
        <h1>Pro Studio ‚Äî Legendary Pro Trim & AI Enhance</h1>
        <p class="muted">Pro timeline trim ‚Ä¢ Separate Voice Editor ‚Ä¢ AI-Enhance audio ‚Ä¢ Auto-caption burn-in ‚Äî single file</p>
      </div>
    </header>

    <div class="grid">
      <!-- left: navigation & quick controls -->
      <div>
        <div class="card nav">
          <div class="section-title"><h2>Menu</h2></div>
          <button class="btn ghost" id="navVideo">üé¨ Video Editor</button>
          <button class="btn ghost" id="navVoice">üó£ Voice Editor</button>
          <button class="btn ghost" id="navExport">üì§ Export</button>
          <div style="margin-top:10px" class="small muted">System</div>
          <div class="row" style="margin-top:8px">
            <button class="btn small" id="btnLoadFF">Load FFmpeg</button>
            <button class="btn small ghost" id="btnReset">Reset</button>
          </div>
          <div style="margin-top:10px">
            <div class="small muted">FFmpeg progress</div>
            <div style="height:8px;background:rgba(255,255,255,0.03);border-radius:6px;margin-top:6px">
              <div id="ffprog" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent2),var(--accent1));border-radius:6px"></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="section-title"><h2>Quick Test</h2></div>
          <div class="small muted">Test assets for quick checks</div>
          <div class="row" style="margin-top:8px">
            <button class="btn small" id="loadTestVideo">Test Video</button>
            <button class="btn small" id="loadTestAudio">Test Audio</button>
          </div>
        </div>
      </div>

      <!-- right: main editor -->
      <div id="mainArea">
        <!-- Video Editor -->
        <div id="viewVideo" class="card">
          <div class="section-title"><h2>üé¨ Video Editor</h2><div style="margin-left:auto" id="videoStatus"><span class="small muted">Upload from phone or desktop</span></div></div>

          <label>Upload video</label>
          <input id="videoInput" type="file" accept="video/*">

          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnTrim" disabled>‚úÇ Trim Selected Range</button>
            <button class="btn ghost small" id="btnAIEnhance" disabled>ü§ñ AI-Enhance Audio</button>
            <button class="btn ghost small" id="btnGenerateCaptions" disabled>üìù Auto-Captions</button>
          </div>

          <div style="margin-top:12px;display:flex;gap:14px;flex-wrap:wrap">
            <div style="flex:1;min-width:260px">
              <label>Background music (optional)</label>
              <input id="bgInput" type="file" accept="audio/*">
              <div class="row" style="margin-top:8px">
                <button class="btn small" id="btnAddBg" disabled>Add BG</button>
                <button class="btn small ghost" id="btnClearBg">Clear BG</button>
              </div>
            </div>
            <div style="width:260px">
              <label>Caption burn-in (optional)</label>
              <input id="captionText" type="text" placeholder="Caption text (auto-populated by Captions)">
              <div class="row" style="margin-top:8px">
                <select id="captionPos"><option value="bottom">Bottom</option><option value="top">Top</option><option value="center">Center</option></select>
                <input id="captionSize" type="number" value="36" min="12" max="120" style="width:90px">
              </div>
            </div>
          </div>

          <div style="margin-top:14px">
            <label>Preview</label>
            <video id="videoPreview" controls playsinline></video>
          </div>

          <div style="margin-top:12px">
            <label class="small muted">Trim Timeline</label>
            <div class="timeline">
              <div class="handles">
                <div class="bar"></div>
                <div class="selectedRange" id="selectedRange" style="left:0%; right:0%"></div>
                <div class="range">
                  <input id="rangeStart" type="range" min="0" max="100" value="0" step="0.01">
                  <input id="rangeEnd" type="range" min="0" max="100" value="100" step="0.01">
                </div>
              </div>
              <div class="timeLabel"><div>Start: <span id="timeStart">0.00s</span></div><div>End: <span id="timeEnd">0.00s</span></div></div>
              <div class="small muted" style="margin-top:8px">Drag handles to choose trim range. Use AI-Enhance to replace audio, and Auto-Captions to generate subtitles.</div>
            </div>
          </div>
        </div>

        <!-- Voice Editor -->
        <div id="viewVoice" class="card" style="margin-top:12px;display:none">
          <div class="section-title"><h2>üó£ Voice Editor</h2><div style="margin-left:auto" id="voiceStatus"><span class="small muted">Record or upload audio</span></div></div>

          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="btnStartMic">Start Mic</button>
            <button class="btn ghost small" id="btnStopMic" disabled>Stop Mic</button>
            <button class="btn" id="btnRecord" disabled>‚óè Record</button>
            <button class="btn ghost small" id="btnStopRecord" disabled>‚ñ† Stop</button>
            <a id="dlRecorded" class="btn ghost small" style="display:none">‚¨á Download</a>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label>Upload audio</label>
              <input id="audioInput" type="file" accept="audio/*">
            </div>
            <div>
              <label>Preview</label>
              <audio id="audioPreview" controls></audio>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Effects</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <div><label>Pitch (semitones)</label><input id="voicePitch" type="number" value="0" min="-12" max="12"></div>
              <div><label>Speed</label><input id="voiceSpeed" type="range" min="0.5" max="2" step="0.01" value="1"></div>
              <div><label>Echo</label><input id="voiceEcho" type="range" min="0" max="0.9" step="0.01" value="0.12"></div>
              <div><label>Noise HP filter</label><input id="voiceNoise" type="range" min="0" max="1200" step="1" value="60"></div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn" id="btnApplyVoice">Apply Effects ‚Üí Preview</button>
              <button class="btn ghost small" id="btnExportVoice">Export WAV</button>
            </div>
          </div>
        </div>

        <!-- Export -->
        <div id="viewExport" class="card" style="margin-top:12px;display:none">
          <div class="section-title"><h2>üì§ Export</h2></div>
          <div class="small muted">Export trimmed video with edited audio and optional caption burn-in.</div>
          <div style="margin-top:12px" class="row">
            <button class="btn" id="btnExportVideo" disabled>Export Video</button>
            <a id="downloadExport" class="btn ghost small" style="display:none">‚¨á Download</a>
          </div>
          <div style="margin-top:10px" class="small muted">Ensure FFmpeg loaded, and an edited audio blob (AI-Enhance or Voice Editor output) is available to replace audio.</div>
          <div style="margin-top:12px"><div class="small muted">Export Log</div><pre id="log" class="log">Ready.</pre></div>
        </div>
      </div>
    </div>

    <footer>Pro Studio ‚Äî high-quality in-browser editing. Best on desktop Chrome/Edge.</footer>
  </div>

<script type="module">
/* ========================
   Pro Studio - Final
   ======================== */

/* Helpers */
const $ = id => document.getElementById(id);
const logEl = $('log');
function log(...p){ const s = p.map(x => typeof x === 'string' ? x : JSON.stringify(x)).join(' '); logEl.textContent += '\n' + s; logEl.scrollTop = logEl.scrollHeight; }
function enable(el){ el.disabled = false; }
function disable(el){ el.disabled = true; }

/* FFmpeg setup */
import { createFFmpeg, fetchFile } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.0/dist/ffmpeg.min.js';
const ffmpeg = createFFmpeg({ log: true });
$('btnLoadFF').addEventListener('click', async ()=>{
  try{
    if(ffmpeg.isLoaded()){ log('FFmpeg already loaded'); $('btnLoadFF').disabled = true; return; }
    log('Loading FFmpeg (20‚Äì60s)...');
    $('btnLoadFF').textContent = 'Loading...'; $('btnLoadFF').disabled = true;
    ffmpeg.setLogger(({message}) => log('[ffmpeg] ' + message));
    ffmpeg.setProgress(({ratio}) => { $('ffprog').style.width = Math.round(ratio*100) + '%'; });
    await ffmpeg.load();
    $('btnLoadFF').textContent = 'FFmpeg Loaded';
    log('FFmpeg loaded.');
    // enable export button if other prerequisites met
    checkExportReady();
  }catch(e){ log('FFmpeg load error', e); alert('FFmpeg load failed (check console)'); $('btnLoadFF').textContent = 'Load FFmpeg'; $('btnLoadFF').disabled=false; }
});

/* Navigation */
function showView(name){
  ['viewVideo','viewVoice','viewExport'].forEach(id => $(id).style.display = (id===name ? 'block' : 'none'));
}
$('navVideo').onclick = ()=> showView('viewVideo');
$('navVoice').onclick = ()=> showView('viewVoice');
$('navExport').onclick = ()=> showView('viewExport');

/* Test assets */
const TEST_VIDEO = 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4';
const TEST_AUDIO = 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3';
$('loadTestVideo').addEventListener('click', async ()=>{
  try{ const r = await fetch(TEST_VIDEO); const b=await r.blob(); const f = new File([b],'test.mp4',{type:b.type}); setVideoFile(f); $('videoInput').files = fileListFromFile(f); log('Test video loaded'); }catch(e){ log('Test video load failed', e); }
});
$('loadTestAudio').addEventListener('click', async ()=>{
  try{ const r = await fetch(TEST_AUDIO); const b=await r.blob(); addBgFile(new File([b],'bg.mp3',{type:b.type})); log('Test audio loaded'); }catch(e){ log('Test audio load failed', e); }
});
function fileListFromFile(file){ const dt = new DataTransfer(); dt.items.add(file); return dt.files; }

/* ---------- Video Editor: timeline and trimming ---------- */
let currentVideoFile = null;
let currentVideoUrl = null;
let videoDuration = 0;
let bgAudioFile = null;
let editedAudioBlob = null; // last processed audio to be used for export (from voice editor or AI-Enhance)

const rangeStart = $('rangeStart');
const rangeEnd = $('rangeEnd');
const selectedRange = $('selectedRange');
const timeStart = $('timeStart');
const timeEnd = $('timeEnd');

$('videoInput').addEventListener('change', e => {
  const f = e.target.files[0]; if(f) setVideoFile(f); else clearVideo();
});

function setVideoFile(f){
  currentVideoFile = f;
  currentVideoUrl = URL.createObjectURL(f);
  $('videoPreview').src = currentVideoUrl;
  $('videoPreview').onloadedmetadata = () => {
    videoDuration = $('videoPreview').duration || 0;
    // initialize handles
    rangeStart.min = 0; rangeStart.max = 100; rangeEnd.min = 0; rangeEnd.max = 100;
    rangeStart.value = 0; rangeEnd.value = 100;
    updateRangeUI();
    enable($('btnTrim')); enable($('btnAIEnhance')); enable($('btnGenerateCaptions')); enable($('btnAddBg'));
    setStatus('Video loaded: ' + f.name);
    log('Video loaded:', f.name, 'duration', videoDuration.toFixed(2)+'s');
    checkExportReady();
  };
}

function clearVideo(){
  currentVideoFile = null; currentVideoUrl = null; $('videoPreview').src = ''; disable($('btnTrim')); disable($('btnAIEnhance')); disable($('btnGenerateCaptions')); disable($('btnAddBg'));
  setStatus('Video cleared'); log('Video cleared'); checkExportReady();
}

function updateRangeUI(){
  // rangeStart & rangeEnd are percentages (0..100)
  let a = parseFloat(rangeStart.value); let b = parseFloat(rangeEnd.value);
  if(a > b){ // swap to avoid inverted selection
    const tmp = a; a = b; b = tmp;
    rangeStart.value = a; rangeEnd.value = b;
  }
  selectedRange.style.left = a + '%';
  selectedRange.style.right = (100 - b) + '%';
  const startSec = (a/100) * videoDuration;
  const endSec = (b/100) * videoDuration;
  timeStart.textContent = startSec.toFixed(2) + 's';
  timeEnd.textContent = endSec.toFixed(2) + 's';
}
rangeStart.addEventListener('input', updateRangeUI);
rangeEnd.addEventListener('input', updateRangeUI);

/* Trim button handler uses start/end (in seconds) */
$('btnTrim').addEventListener('click', async ()=>{
  if(!currentVideoFile) return alert('Upload a video first');
  if(!ffmpeg.isLoaded()){ alert('Please load FFmpeg first'); return; }
  const a = parseFloat(rangeStart.value)/100 * videoDuration;
  const b = parseFloat(rangeEnd.value)/100 * videoDuration;
  if(b - a < 0.05) return alert('Trim length too short');
  try{
    $('btnTrim').disabled = true; setStatus('Trimming...'); log('Trim start', a.toFixed(2), '‚Üí', b.toFixed(2));
    await ffmpeg.FS('writeFile','input.mp4', await fetchFile(currentVideoFile));
    // if caption text provided, build drawtext filter
    const caption = $('captionText').value.trim();
    const captionSize = Math.max(12, Number($('captionSize').value || 36));
    const pos = $('captionPos').value;
    let vfArgs = [];
    if(caption){
      const y = pos === 'top' ? '20' : (pos === 'center' ? '(h-text_h)/2' : 'h-text_h-20');
      vfArgs = ['-vf', `drawtext=text='${caption.replace(/'/g,"\\'")}':fontcolor=white:fontsize=${captionSize}:x=(w-text_w)/2:y=${y}:box=1:boxcolor=black@0.5`];
    }
    // prepare args
    const args = ['-i','input.mp4','-ss',String(a.toFixed(2)),'-to',String(b.toFixed(2)),'-c:v','libx264','-preset','veryfast','-c:a','aac','-b:a','160k', ...vfArgs, 'trim_out.mp4'];
    await ffmpeg.run(...args);
    const out = ffmpeg.FS('readFile','trim_out.mp4');
    const blob = new Blob([out.buffer], {type:'video/mp4'});
    const url = URL.createObjectURL(blob);
    $('videoPreview').src = url;
    setStatus('Trim complete ‚Äî preview updated'); log('Trim complete');
    try{ ffmpeg.FS('unlink','input.mp4'); ffmpeg.FS('unlink','trim_out.mp4'); }catch(e){}
  }catch(err){ console.error(err); log('Trim error', err); alert('Trim failed ‚Äî see log'); setStatus('Trim failed'); }
  finally{ $('btnTrim').disabled = false; }
});

/* Background music */
$('bgInput').addEventListener('change', e => { if(e.target.files[0]) enable($('btnAddBg')); });
$('btnAddBg').addEventListener('click', ()=> {
  const f = $('bgInput').files[0];
  if(!f) return alert('Select BG audio first');
  addBgFile(f);
});
$('btnClearBg').addEventListener('click', ()=> { bgAudioFile=null; $('bgInput').value=''; log('BG cleared'); });

function addBgFile(file){ bgAudioFile = file; log('BG added:', file.name); setStatus('Background music ready'); checkExportReady(); }

/* ---------------------------
   AI-Enhance: process audio track of current video
   --------------------------- */
$('btnAIEnhance').addEventListener('click', async ()=>{
  if(!currentVideoFile) return alert('Upload a video first');
  setStatus('Extracting audio & enhancing...'); log('AI-Enhance start');
  try{
    // ensure ffmpeg loaded
    if(!ffmpeg.isLoaded()){ alert('Load FFmpeg first'); return; }
    // write video
    $('btnAIEnhance').disabled = true;
    await ffmpeg.FS('writeFile','v_in.mp4', await fetchFile(currentVideoFile));
    // extract audio as WAV
    await ffmpeg.run('-
